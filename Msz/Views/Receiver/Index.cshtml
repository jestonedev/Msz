@using Msz.ViewModels
@model ReceiverIndexViewModel

@{
    ViewData["Title"] = "Реестр получателей МСЗ";
    var props = new Dictionary<string, string>();
    var filtered = false;
    foreach (var property in Model.FilterOptions.GetType().GetProperties())
    {
        var value = property.GetValue(Model.FilterOptions);
        if (value == null) { continue; }
        if (property.Name != "IncludeReasonPersonsInFiltering")
        {
            filtered = true;
        }
        props.Add("FilterOptions." + property.Name, property.GetValue(Model.FilterOptions).ToString());
    }
}

<h2>Получатели мер социальной поддержки</h2>
@if (TempData.ContainsKey("Error"))
{
    <div class="alert alert-danger msz-error-alert" role="alert">@TempData["Error"]</div>
}

@if (TempData.ContainsKey("Success"))
{
    <div class="alert alert-success msz-success-alert" role="alert">@TempData["Success"]</div>
}
<div class="msz-tool-panel">
    <div class="col-xs-12 msz-tool-group">
        <div class="row">
            <div class="btn-group msz-egisso-btn-group">
                <button type="button" class="btn btn-success dropdown-toggle msz-egisso-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="msz-glyphicon glyphicon glyphicon-briefcase" aria-hidden="true"></span> ЕГИССО <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a asp-action="DownloadFilteredRecievers"
                           asp-all-route-data="@props">
                            Выгрузить отфильтрованных получателей
                        </a>
                    </li>
                    <li>
                        <form asp-action="UpdateMszAndCategories" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="returnUrl" value="@($"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}")" />
                            <input type="file" id="msz-category-file-btn" name="xml" href="#">
                            <label for="msz-category-file-btn">Обновить категории и МСЗ</label>
                        </form>
                    </li>
                </ul>
            </div>
            <div class="btn-group msz-search-btn-group">
                <button type="button" class="btn btn-success dropdown-toggle msz-search-toggle-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="msz-glyphicon glyphicon glyphicon-search" aria-hidden="true"></span> Фильтрация <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a href="#" class="msz-dd-search-btn @(filtered ? "msz-active" : "")">Применить фильтр</a>
                    </li>
                    <li>
                        <a asp-action="Index" class="msz-dd-cancel-search-btn @(filtered ? "" : "msz-disabled")">Отменить фильтр</a>
                    </li>
                </ul>
            </div>

            <a href="#" class="btn btn-success msz-search-btn @(filtered ? "active" : "")"><span class="msz-glyphicon glyphicon glyphicon-search" aria-hidden="true"></span> Применить фильтр</a>
            <a asp-action="Index" class="btn btn-success msz-cancel-search-btn @(filtered ? "" : "disabled")"><span class="msz-glyphicon glyphicon glyphicon-remove" aria-hidden="true"></span> Отменить фильтр</a>
            <a asp-action="Add" class="btn btn-success msz-add-receiver-btn"><span class="msz-glyphicon glyphicon glyphicon-plus" aria-hidden="true"></span> Добавить получателя</a>
        </div>
    </div>
</div>
<div class="clearfix"></div>
<div class="msz-receiver-table-wrapper table-responsive">
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Дата последнего изменения</th>
                <th>ФИО получателя</th>
                <th>Дата рождения получателя</th>
                <th>СНИЛС получателя</th>
                <th>МСЗ</th>
                <th>Категория</th>
                <th>Решение</th>
                <th>Период действия</th>
                <th class="msz-receiver-table-control"></th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Receivers.Any())
            {
                @foreach (var receiver in Model.Receivers)
                {
                    <tr>
                        <td>@receiver.CreatedDate.ToString("dd.MM.yyyy hh:mm:ss")</td>
                        <td>@receiver.Surname @receiver.Name@(receiver.Patronymic != null ? " " + receiver.Patronymic : "")</td>
                        <td>@receiver.BirthDate.ToString("dd.MM.yyyy")</td>
                        <td>@receiver.Snils</td>
                        <td>@receiver.Msz.Name</td>
                        <td>@receiver.Category.Name</td>
                        <td>@(receiver.DecisionNumber != null ? receiver.DecisionNumber : "б/н") от @receiver.DecisionDate.ToString("dd.MM.yyyy")</td>
                        <td>c @receiver.StartDate.ToString("dd.MM.yyyy")@(@receiver.EndDate != null ? " по " + receiver.EndDate?.ToString("dd.MM.yyyy") : "")</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="msz-receiver-table-empty">Получатели отсутствуют</td>
                </tr>
            }

        </tbody>
    </table>
</div>
<nav>
    <ul class="pagination msz-pagination">

        <li class="@(Model.PageOptions.PageIndex == 0 ? "disabled" : "")">
            <a asp-all-route-data="@props" asp-route-PageOptions.PageIndex="@(Model.PageOptions.PageIndex - 1)" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        @{
            var startIndex = Math.Max(0, Model.PageOptions.PageIndex - 5);
            var endIndex = Math.Min(Model.PageOptions.PageCount - 1, Model.PageOptions.PageIndex + 5);
            var delta = endIndex - startIndex;
            if (delta <= 10)
            {
                if (startIndex == 0)
                {
                    endIndex = Math.Min(endIndex + 10 - delta, Model.PageOptions.PageCount - 1);
                }
                if (endIndex == Model.PageOptions.PageCount - 1)
                {
                    startIndex = Math.Max(startIndex - 10 + delta, 0);
                }
            }
        }
        @for (var i = startIndex; i <= endIndex; i++)
        {
            <li class="@(Model.PageOptions.PageIndex == i ? "active" : "")">
                <a asp-all-route-data="@props" asp-route-PageOptions.PageIndex="@i">@(i + 1)</a>
            </li>
        }
        <li class="@(Model.PageOptions.PageIndex >= Model.PageOptions.PageCount - 1 ? "disabled" : "")">
            <a asp-all-route-data="@props" asp-route-PageOptions.PageIndex="@(Model.PageOptions.PageIndex + 1)" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>